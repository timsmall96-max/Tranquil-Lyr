<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tranquil Lyrics</title>
  <style>
  :root {
  --overlay: rgba(0, 0, 0, 0.45);
  --editor-bg: rgba(20, 20, 25, 0.65);
  --text-color: #f2f6ff;
  --gutter-bg: rgba(0, 0, 0, 0.35);
  --gutter-text: #9fd3ff;
  --font: "Georgia", serif;
  --font-size: 17px;
}

 html, body {
  margin: 0;
  padding: 0;
  overflow: hidden;
  font-family: var(--font);
  height: 100%;
}

    body {
  background-image: url("https://raw.githubusercontent.com/timsmall96-max/Image/main/BG.jpg");
  background-size: cover;
  background-position: center;
  background-repeat: no-repeat;
  overflow-x: hidden; /* ‚úÖ correct placement */
}

.overlay {
  position: fixed;
  inset: 0;
  height: 100vh;          /* ‚¨ÖÔ∏è THIS is the key addition */
  background: var(--overlay);
  display: flex;
  justify-content: center;
  align-items: stretch;
  overflow: hidden;
}

.editor-wrapper {
  width: 90%;
  max-width: 1000px;
  margin: 20px;
  background: var(--editor-bg);
  border-radius: 10px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  flex: 1;
  min-height: 0;
  height: calc(100% - 40px); /* ‚¨ÖÔ∏è key fix */
}

    


    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 10px;
      background: rgba(0,0,0,0.4);
    }

    .toolbar button, .toolbar input {
      background: rgba(255,255,255,0.15);
      color: white;
      border: none;
      padding: 6px 10px;
      border-radius: 4px;
      cursor: pointer;
    }

    .toolbar button:hover {
      background: rgba(255,255,255,0.3);
    }

   .editor-area {
  display: flex;
  flex: 1;
  min-height: 0;
  overflow: hidden;
}

    .gutter {
      background: transparent;
      color: var(--text-color);
      padding: 10px;
      text-align: right;
      min-width: 60px;
      line-height: 1.4;
      white-space: pre;
      user-select: none;
      overflow: hidden;
      font-size: var(--font-size);
      font-family: var(--font);
    }

    #editor {
      flex: 1;
      padding: 10px;
      background: transparent;
      color: var(--text-color);
      font-size: var(--font-size);
      line-height: 1.4;
      outline: none;
      overflow: auto;
      white-space: pre-wrap;
    }

   .reference-panel {
  background: rgba(0, 0, 0, 0.35);
  display: flex;
  flex-direction: column;

  /* ‚úÖ SAFE sizing inside flex */
  flex: 0 0 auto;
  min-height: 160px;
}

    .reference-panel:fullscreen {
      height: 100%;
      border-radius: 0;
    }

    .reference-tabs {
      display: flex;
      gap: 8px;
      padding: 8px;
    }

    .tab {
      background: rgba(255,255,255,0.15);
      border: none;
      color: white;
      padding: 6px 10px;
      border-radius: 999px;
      cursor: pointer;
    }

    .tab.active {
      background: rgba(255,255,255,0.35);
    }

    .reference-hint {
      display: none;
      padding: 6px 10px;
      font-size: 12px;
      color: #ddd;
    }

    .reference-frame {
      flex: 1;
      border: none;
    }
.layout-container {
  display: flex;
  width: 100%;
  height: 100%;
  min-height: 0; /* critical for nested flex scrolling */
  align-items: stretch;
}

.metronome-panel {
  width: 60px;
  background: rgba(0, 0, 0, 0.4);
  color: white;
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px 5px;
  gap: 10px;
  font-size: 14px;
  overflow-y: auto;
}

.metronome-panel input {
  width: 40px;
  text-align: center;
  background: rgba(255, 255, 255, 0.15);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px;
}

.metronome-panel button {
  background: rgba(255, 255, 255, 0.15);
  color: white;
  border: none;
  border-radius: 4px;
  padding: 4px 6px;
  cursor: pointer;
}

.metronome-panel button:hover {
  background: rgba(255, 255, 255, 0.3);
}
.metronome-light {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  background-color: #222;
  border: 2px solid #555;
  box-shadow: 0 0 4px #000;
  transition: background-color 0.1s ease, box-shadow 0.1s ease;
}
.metronome-light.on {
  background-color: #3fa;
  box-shadow: 0 0 8px #3fa;
}
.metronome-light.first {
  background-color: #f44;
  box-shadow: 0 0 10px #f44;
}

/* ===============================
   REPETITION BUTTON POLISH
   =============================== */

#repToggle {
  transition: opacity 0.2s ease, background 0.2s ease;
}

#repToggle.active {
  background: rgba(255, 100, 100, 0.35);
}
/* ===============================
   SIMPLE BEAT PULSE (SAFE)
   =============================== */

#editor.beat-pulse {
  animation: beatPulse 0.12s ease-out;
}

#editor.beat-pulse.first {
  animation: beatPulseFirst 0.12s ease-out;
}

@keyframes beatPulse {
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); }
  60%  { box-shadow: 0 0 14px rgba(255,255,255,0.25); }
  100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
}

@keyframes beatPulseFirst {
  0%   { box-shadow: 0 0 0 rgba(255,255,255,0); }
  60%  { box-shadow: 0 0 18px rgba(255,120,120,0.35); }
  100% { box-shadow: 0 0 0 rgba(255,255,255,0); }
}

/* ===============================
   PERFORMANCE MODE
   =============================== */

body.performance-mode .toolbar,
body.performance-mode .reference-panel {
  display: none;
}

body.performance-mode .editor-wrapper {
  max-width: none;
  width: 100%;
  margin: 0;
  border-radius: 0;
}

body.performance-mode #editor {
  font-size: calc(var(--font-size) * 1.6);
  line-height: 1.6;
}

body.performance-mode .gutter {
  font-size: calc(var(--font-size) * 1.6);
  opacity: 0.7;
}

body.performance-mode {
  background-color: #000;
}

body.performance-mode .overlay {
  background: rgba(0, 0, 0, 0.75);
}

/* Hide syllable gutter in Performance Mode */
body.performance-mode .gutter {
  display: none;
}

/* ===============================
   MOBILE REFERENCE TAB FIX
   =============================== */

@media (max-width: 768px) {
  .reference-tabs {
    gap: 6px;
    padding: 6px;
    flex-wrap: nowrap;
    overflow-x: auto;
  }

  .reference-tabs .tab {
    padding: 6px 8px;
    font-size: 12px;
    border-radius: 8px;
    white-space: nowrap;
  }
}


@media (max-width: 768px) {
  body.performance-mode .reference-panel {
    display: none;
  }
}

  </style>
</head>

<body>
<div class="overlay">
  <div class="layout-container">
 <!-- LEFT COLUMN: Metronome Panel -->
   

   
<div class="metronome-panel">
  <div id="metronomeLight" class="metronome-light"></div>

  <label for="timeSignature" style="font-size: 12px;">TS</label>
  <select id="timeSignature" style="width: 50px;">
    <option value="4">4/4</option>
    <option value="3">3/4</option>
    <option value="5">5/4</option>
    <option value="6">6/8</option>
    <option value="7">7/8</option>
  </select>

  <button id="metronomeToggle">Start</button>
  <input id="bpmInput" type="number" min="30" max="300" value="100" />

  <label style="font-size: 12px;">Rhythm</label>
  <div id="rhythmLight" style="
    width: 16px;
    height: 16px;
    border-radius: 50%;
    background-color: #444;
    border: 2px solid #555;
    box-shadow: 0 0 4px #000;
    transition: background-color 0.2s ease, box-shadow 0.2s ease;">
  </div>
<div style="display:flex; gap:10px; flex-wrap:wrap; font-size:12px;">
  <label>
    Padding
    <input type="range" id="padSlider" min="0.3" max="0.8" step="0.01" value="0.45">
  </label>

  <label>
    Density
    <input type="range" id="densitySlider" min="0.2" max="0.6" step="0.01" value="0.38">
  </label>

  <label>
    Variance
    <input type="range" id="varianceSlider" min="1" max="5" step="0.1" value="2.8">
  </label>

  <label>
    Gap
    <input type="range" id="gapSlider" min="1" max="6" step="0.1" value="4.5">
  </label>
  <button id="repToggle">Repetition</button>
  <button id="performanceToggle">Performance</button>
</div>

</div>


  <!-- RIGHT: Existing Editor -->
    <div class="editor-wrapper">
        
      <!-- your editor, toolbar, etc. stays the same -->
    <input
  id="songTitle"
  type="text"
  placeholder="Song Title"
  style="
    background: transparent;
    color: var(--text-color);
    border: none;
    border-bottom: 1px solid rgba(255,255,255,0.3);
    padding: 10px;
    font-size: 22px;
    font-weight: bold;
    outline: none;
  "
/>

    <!-- Toolbar -->
    <div class="toolbar">
      <button id="newBtn">Start New</button>
      <button id="openBtn">Open</button>
      <button id="saveBtn">Save</button>
      <button id="saveAsBtn">Save As</button>
      <button id="refFullscreenBtn">Reference Fullscreen</button>
      <button id="fontDown">A‚àí</button>
      <button id="fontUp">A+</button>
      <label>Text <input type="color" id="textColor"></label>
      <label>Highlight <input type="color" id="highlightColor" value="#ffff00"></label>
      <button id="highlightBtn">Highlight</button>
      <button id="emailBtn">Send Email</button>
      <label>
        üìê Ref Height
        <input type="range" id="refSizeSlider" min="100" max="600" value="260" style="width: 100px;">
      </label>
    </div>
    
    <!-- Repetition Alert -->
<div id="repetitionAlert" style="
  display:none;
  background: rgba(255,80,80,0.15);
  color: #ffdede;
  font-size: 13px;
  padding: 6px 10px;
  border-top: 1px solid rgba(255,80,80,0.3);
  border-bottom: 1px solid rgba(255,80,80,0.3);
">
</div>
    <!-- Editor Area -->
    <div class="editor-area">
      <div id="gutter" class="gutter"></div>
      <div id="editor" contenteditable="true"></div>
    </div>

    
<!-- Reference Panel -->
<div class="reference-panel">
  <div class="reference-tabs">
    <button class="tab active" data-site="rhyme">Rhyme</button>
    <button class="tab" data-site="thesaurus">Thesaurus</button>
    <button class="tab" data-site="obscure">Obscure</button>
    <button class="tab" data-site="exercises">Exercises</button>
    <button class="tab" data-site="unsplash">Images</button>
    <button class="tab" data-site="wiki">Wiki</button>
    <button class="tab" data-site="askai">AI</button>
  </div>

  <div id="referenceHint" class="reference-hint"></div>

  <iframe
    id="referenceFrame"
    class="reference-frame"
    src="https://www.rhymezone.com/"
  ></iframe>
</div>


  </div>
</div>

<script>
const editor = document.getElementById("editor");
const gutter = document.getElementById("gutter");
const frame = document.getElementById("referenceFrame");
const hint = document.getElementById("referenceHint");
const root = document.documentElement.style;
const rhythmLight = document.getElementById("rhythmLight");

/* ===============================
   LOAD CMU DICTIONARY (Netlify-safe)
   =============================== */

let CMU_DICT = null;


window.addEventListener("DOMContentLoaded", () => {
  fetch("/cmudict.json")
    .then(res => {
      if (!res.ok) {
        throw new Error(`Failed to load cumudict.json (${res.status})`);
      }
      return res.json();
    })
    .then(data => {
      CMU_DICT = data;
      console.log("CMU Dictionary loaded:", Object.keys(data).length);
      updateGutter(); // ‚Üê this is the important line
    })
    .catch(err => {
      console.error("CMU Dictionary load error:", err);
    });
});

const LYRICS_KEY = "tranquilLyrics_autosave";
const TITLE_KEY = "tranquilLyrics_title";
const titleInput = document.getElementById("songTitle");
const savedTitle = localStorage.getItem(TITLE_KEY);
if (savedTitle) titleInput.value = savedTitle;
let PAD_THRESHOLD = 0.45;
let DENSITY_THRESHOLD = 0.38;
let VARIANCE_THRESHOLD = 2.8;
let MAX_GAP = 4.5;
const padSlider = document.getElementById("padSlider");
const densitySlider = document.getElementById("densitySlider");
const varianceSlider = document.getElementById("varianceSlider");
const gapSlider = document.getElementById("gapSlider");

padSlider.oninput = e => PAD_THRESHOLD = +e.target.value;
densitySlider.oninput = e => DENSITY_THRESHOLD = +e.target.value;
varianceSlider.oninput = e => VARIANCE_THRESHOLD = +e.target.value;
gapSlider.oninput = e => MAX_GAP = +e.target.value;
const STRESS_THRESHOLD = 0.35;   // lower = stricter


function makeSafeFilename(name) {
  return name
    .trim()
    .replace(/[<>:"/\\|?*\x00-\x1F]/g, "")
    .replace(/\s+/g, " ")
    .slice(0, 100) || "lyrics";
}

/* === Load Saved Settings === */
const save = (k, v) => localStorage.setItem(k, v);
const load = k => localStorage.getItem(k);

function loadSettings() {
  const fontSize = load("fontSize");
  const textColor = load("textColor");

  if (fontSize) root.setProperty("--font-size", fontSize);
  if (textColor) {
    root.setProperty("--text-color", textColor);
    document.getElementById("textColor").value = textColor;
  }
}
loadSettings();

/* === Syllable Count === */
function countSyllables(word) {
  if (!word) return 0;

  const clean = word.toLowerCase().replace(/[^a-z']/g, "");

  // ‚úÖ Use CMU dictionary if loaded
  if (CMU_DICT && CMU_DICT[clean]) {
    // CMU format: array of phoneme arrays
    // Count vowel phonemes (they end in a digit)
    const pronunciation = CMU_DICT[clean][0];
    return pronunciation.filter(p => /\d$/.test(p)).length;
  }

  // üîÅ Fallback heuristic (your original logic)
  if (clean.length <= 3) return clean ? 1 : 0;
  const w = clean.replace(/e$/, "");
  const g = w.match(/[aeiouy]+/g);
  return g ? g.length : 1;
}

/* ===============================
   STRESS + PADDING HELPERS
   =============================== */

const FILLER_WORDS = new Set([
  "the","a","an","to","of","and","but","or","so",
  "that","this","it","is","was","were","been",
  "i","you","we","they","me","my","your","our",
  "just","really","very","so","like","yeah","oh"
]);

function getWordStress(word) {
  const clean = word.toLowerCase().replace(/[^a-z']/g, "");
  if (!CMU_DICT || !CMU_DICT[clean]) return [];

  return CMU_DICT[clean][0]
    .filter(p => /\d$/.test(p))
    .map(p => p.slice(-1)); // "0", "1", "2"
}

function getLineStressPattern(line) {
  return line
    .split(/\s+/)
    .flatMap(word => getWordStress(word));
}

function stressMismatchScore(a, b) {
  const len = Math.min(a.length, b.length);
  if (len === 0) return 0;


  let mismatches = 0;
  for (let i = 0; i < len; i++) {
    const aStrong = a[i] !== "0";
    const bStrong = b[i] !== "0";
    if (aStrong !== bStrong) mismatches++;
  }

  return mismatches / len; // 0 = perfect
}

function paddingDensity(line) {
  const words = line.toLowerCase().split(/\s+/);
  if (!words.length) return 0;

  const fillerCount = words.filter(w => FILLER_WORDS.has(w)).length;
  return fillerCount / words.length;
}


function updateGutter() {
  gutter.textContent = editor.innerText
    .split("\n")
    .map(line =>
      line.split(/\s+/).filter(Boolean)
      .reduce((sum, w) => sum + countSyllables(w), 0)
    ).join("\n");
}
// === Restore saved lyrics ===
const savedLyrics = localStorage.getItem(LYRICS_KEY);
if (savedLyrics) {
  editor.innerHTML = savedLyrics;
  updateGutter();
}

/* ===============================
   REPETITION ALERT
   =============================== */

const repetitionAlert = document.getElementById("repetitionAlert");
const repToggle = document.getElementById("repToggle");

let repetitionEnabled = true;

repToggle.onclick = () => {
  repetitionEnabled = !repetitionEnabled;

  repetitionAlert.style.display = repetitionEnabled ? "block" : "none";
  repToggle.classList.toggle("active", repetitionEnabled);
  repToggle.textContent = repetitionEnabled
    ? "Repetition On"
    : "Repetition Off";
};

const STOP_WORDS = new Set([
  "the","and","a","to","of","in","on","it","is","that","for","with",
  "i","you","me","my","your","we","they","he","she","it's","im"
]);

function normalizeLyrics(text) {
  return text
    .toLowerCase()
    .replace(/[^\w\s']/g, "")
    .split(/\s+/)
    .filter(Boolean);
}

function findRepeatedWords(words, minCount = 3) {
  const counts = {};
  for (const w of words) {
    if (STOP_WORDS.has(w)) continue;
    counts[w] = (counts[w] || 0) + 1;
  }

  return Object.entries(counts)
    .filter(([, count]) => count >= minCount)
    .sort((a, b) => b[1] - a[1]);
}

function updateRepetitionAlert() {
  const words = normalizeLyrics(editor.innerText);
  const repeats = findRepeatedWords(words);

  if (!repeats.length) {
    repetitionAlert.style.display = "none";
    repetitionAlert.innerHTML = "";
    return;
  }

  repetitionAlert.style.display = "block";
  repetitionAlert.innerHTML =
    "‚ôªÔ∏è Repetition noticed: " +
    repeats
      .slice(0, 5)
      .map(([word, count]) => `"${word}" √ó${count}`)
      .join(" ¬∑ ");
}

titleInput.addEventListener("input", () => {
  localStorage.setItem(TITLE_KEY, titleInput.value);
});
editor.addEventListener("input", updateGutter);
editor.addEventListener("scroll", () => gutter.scrollTop = editor.scrollTop);
updateGutter();
editor.addEventListener("input", () => {
  localStorage.setItem(LYRICS_KEY, editor.innerHTML);
});

editor.addEventListener("input", updateRepetitionAlert);
/* === Fix Enter Key (Single Line Break) === */
editor.addEventListener("keydown", function(e) {
  if (e.key === "Enter") {
    e.preventDefault();
    const br = document.createElement("br");
    const selection = window.getSelection();
    const range = selection.getRangeAt(0);
    range.deleteContents();
    range.insertNode(br);
    const newRange = document.createRange();
    newRange.setStartAfter(br);
    newRange.collapse(true);
    selection.removeAllRanges();
    selection.addRange(newRange);
    updateGutter();
  }
});

/* === Font Controls === */
function getFontSize() {
  return parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--font-size"));
}

document.getElementById("fontUp").onclick = () => {
  const size = Math.min(getFontSize() + 1, 72);
  root.setProperty("--font-size", size + "px");
  save("fontSize", size + "px");
  updateGutter();
};

document.getElementById("fontDown").onclick = () => {
  const size = Math.max(getFontSize() - 1, 8);
  root.setProperty("--font-size", size + "px");
  save("fontSize", size + "px");
  updateGutter();
};

/* === Color Picker === */
document.getElementById("textColor").addEventListener("input", e => {
  root.setProperty("--text-color", e.target.value);
  save("textColor", e.target.value);
});

/* === Highlight Selected Text === */
document.getElementById("highlightBtn").onclick = () => {
  const color = document.getElementById("highlightColor").value;
  const sel = window.getSelection();
  if (!sel.rangeCount || sel.isCollapsed) return;
  const range = sel.getRangeAt(0);
  const span = document.createElement("span");
  span.style.backgroundColor = color;
  span.textContent = range.toString();
  range.deleteContents();
  range.insertNode(span);
  sel.removeAllRanges();
};

/* ===============================
   SAVE / OPEN / NEW
   =============================== */

// Helper: build file content (title + lyrics)
function getFileContent() {
  return (titleInput.value ? titleInput.value + "\n\n" : "") +
         editor.innerText;
}

// Helper: parse file content back into title + lyrics
function parseFileContent(text) {
  const lines = text.split("\n");

  if (lines[0]?.trim() && lines[1]?.trim() === "") {
    titleInput.value = lines.shift();
    lines.shift();
  } else {
    titleInput.value = "";
  }

  editor.innerText = lines.join("\n");
  updateGutter();

  // sync autosave
  localStorage.setItem(TITLE_KEY, titleInput.value);
  localStorage.setItem(LYRICS_KEY, editor.innerHTML);
}

// SAVE (auto filename from title)
document.getElementById("saveBtn").onclick = () => {
  const name =
    (titleInput.value && makeSafeFilename(titleInput.value)) || "lyrics";

  const blob = new Blob([getFileContent()], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = name + ".txt";
  a.click();
};

// SAVE AS
document.getElementById("saveAsBtn").onclick = () => {
  const defaultName =
    (titleInput.value && makeSafeFilename(titleInput.value)) || "lyrics";

  const filename = prompt("Save as:", defaultName);
  if (!filename) return;

  const blob = new Blob([getFileContent()], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = filename.endsWith(".txt")
    ? filename
    : filename + ".txt";
  a.click();
};

// OPEN
document.getElementById("openBtn").onclick = () => {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = ".txt";

  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;

    file.text().then(parseFileContent);
  };

  input.click();
};

// NEW
document.getElementById("newBtn").onclick = () => {
  if (!confirm("Start a new song? Unsaved changes will be lost.")) return;

  titleInput.value = "";
  editor.innerText = "";
  updateGutter();

  localStorage.removeItem(TITLE_KEY);
  localStorage.removeItem(LYRICS_KEY);
};

/* ===============================
   REFERENCE TABS
   =============================== */

function setTab(key) {
  document.querySelectorAll(".tab").forEach(tab => {
    tab.classList.toggle("active", tab.dataset.site === key);
  });

  hint.style.display = "none";

  if (key === "rhyme") {
    frame.src = "https://www.rhymezone.com/";
  }

  if (key === "thesaurus") {
    frame.src = "https://www.thesaurus.com/";
  }

  if (key === "obscure") {
    frame.src = "https://www.dictionaryofobscuresorrows.com/";
  }

  if (key === "exercises") {
    frame.src = "https://writingexercises.co.uk/";
  }

  if (key === "unsplash") {
    frame.src = "https://unsplash.com/";
    hint.style.display = "block";
    hint.innerHTML = "üñºÔ∏è Use images for mood & imagery ‚Äî avoid literal descriptions.";
  }

  if (key === "wiki") {
    frame.src = "https://en.wikipedia.org/wiki/Main_Page";
  }

  if (key === "askai") {
    frame.src = "https://yuntian-deng-chatgpt.hf.space/";
    hint.style.display = "block";
    hint.innerHTML = `üß† Chat with AI below.`;
  }
}

document.querySelectorAll(".tab").forEach(tab => {
  tab.addEventListener("click", () => {
    setTab(tab.dataset.site);
  });
});

/* ===============================
   DOUBLE-CLICK ‚Üí RHYMEZONE
   =============================== */

editor.addEventListener("dblclick", () => {
  const word = window.getSelection().toString().trim();
  if (!word || !/^[a-zA-Z]+$/.test(word)) return;

  const url =
    `https://www.rhymezone.com/r/rhyme.cgi?Word=${encodeURIComponent(word)}&typeofrhyme=perfect`;

  setTab("rhyme");
  frame.src = url;
  hint.style.display = "block";
  hint.innerHTML =
    `üîç Searching <strong>${word}</strong> in RhymeZone.<br>
     If results don‚Äôt load,
     <a href="${url}" target="_blank">click here</a>.`;
});

/* ===============================
   METRONOME
   =============================== */

let metronomeInterval = null;
let beatCount = 0;

const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
   async function ensureAudio() {
  if (audioCtx.state !== "running") {
    try { await audioCtx.resume(); } catch(e) {}
  }
}
const metronomeLight = document.getElementById("metronomeLight");
const bpmInput = document.getElementById("bpmInput");
const toggleBtn = document.getElementById("metronomeToggle");
const timeSignatureSelect = document.getElementById("timeSignature");

let beatsPerMeasure = parseInt(timeSignatureSelect.value);

// Update beats per measure when time signature changes
timeSignatureSelect.addEventListener("change", () => {
  beatsPerMeasure = parseInt(timeSignatureSelect.value);
  beatCount = 0;
});

// Play a single metronome tick
function playTick() {
  const isFirstBeat = beatCount % beatsPerMeasure === 0;

  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();

  osc.type = "sine";
  osc.frequency.setValueAtTime(
    isFirstBeat ? 1500 : 1000,
    audioCtx.currentTime
  );

  gain.gain.setValueAtTime(0, audioCtx.currentTime);
  gain.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
  gain.gain.exponentialRampToValueAtTime(
    0.001,
    audioCtx.currentTime + 0.1
  );

  osc.connect(gain);
  gain.connect(audioCtx.destination);

  osc.start(audioCtx.currentTime);
  osc.stop(audioCtx.currentTime + 0.15);

  // Light flash
  metronomeLight.classList.remove("on", "first");
  void metronomeLight.offsetWidth; // restart animation
  metronomeLight.classList.add(isFirstBeat ? "first" : "on");

  setTimeout(() => {
    metronomeLight.classList.remove("on", "first");
  }, 100);
editor.classList.remove("beat-pulse", "first");
void editor.offsetWidth; // restart animation
editor.classList.add("beat-pulse");
if (isFirstBeat) editor.classList.add("first");
  beatCount++;
}

// Start metronome
function startMetronome(bpm) {
  const interval = 60000 / bpm;
  playTick();
  metronomeInterval = setInterval(playTick, interval);
}

// Stop metronome
function stopMetronome() {
  clearInterval(metronomeInterval);
  metronomeInterval = null;
  beatCount = 0;
}

// Toggle button
toggleBtn.addEventListener("click", async () => {
  const bpm = parseInt(bpmInput.value);

  if (metronomeInterval) {
    stopMetronome();
    toggleBtn.textContent = "Start";
  } else if (!isNaN(bpm) && bpm > 0) {
    await ensureAudio();
    startMetronome(bpm);
    toggleBtn.textContent = "Stop";
  }
});
    

/* ===============================
   REFERENCE SIZE SLIDER
   =============================== */

const refPanel = document.querySelector(".reference-panel");
const refSlider = document.getElementById("refSizeSlider");

refSlider.addEventListener("input", () => {
  refPanel.style.height = refSlider.value + "px";

});


/* ===============================
   REFERENCE FULLSCREEN
   =============================== */

const fsBtn = document.getElementById("refFullscreenBtn");

fsBtn.addEventListener("click", async () => {
  if (!document.fullscreenElement) {
    await refPanel.requestFullscreen();
  } else {
    await document.exitFullscreen();
  }
});

document.addEventListener("fullscreenchange", () => {
  fsBtn.textContent = document.fullscreenElement
    ? "Exit Fullscreen"
    : "Reference Fullscreen";
});

/* ===============================
   PERFORMANCE MODE TOGGLE
   =============================== */

const performanceBtn = document.getElementById("performanceToggle");

performanceBtn.onclick = () => {
  document.body.classList.toggle("performance-mode");

  performanceBtn.textContent =
    document.body.classList.contains("performance-mode")
      ? "Exit Performance"
      : "Performance";
};
function updateRhythmLight() {
  const selection = window.getSelection();

  if (!selection || selection.isCollapsed) {
    turnRhythmOff();
    return;
  }

  const range = selection.getRangeAt(0);
  if (!editor.contains(range.commonAncestorContainer)) {
    turnRhythmOff();
    return;
  }

  const lines = selection.toString()
    .split("\n")
    .map(l => l.trim())
    .filter(Boolean);

  if (lines.length < 2) {
    turnRhythmOff();
    return;
  }

  // === SYLLABLE CHECK ===
  const syllables = lines.map(line =>
    line.split(/\s+/)
      .reduce((sum, w) => sum + countSyllables(w), 0)
  );

  const avg = syllables.reduce((a, b) => a + b, 0) / syllables.length;
  const variance =
    syllables.reduce((s, n) => s + Math.abs(n - avg), 0) /
    syllables.length;

  // === STRESS CHECK (compare first two lines) ===
  const stressA = getLineStressPattern(lines[0]);
  const stressB = getLineStressPattern(lines[1]);
  const stressMismatch = stressMismatchScore(stressA, stressB);

// === PADDING CHECK ===
const paddingA = paddingDensity(lines[0]);
const paddingB = paddingDensity(lines[1]);
const padded = Math.max(paddingA, paddingB) > PAD_THRESHOLD;

const pass =
  variance <= VARIANCE_THRESHOLD &&
  stressMismatch <= STRESS_THRESHOLD &&
  !padded;


  if (pass) {
    rhythmLight.style.backgroundColor = "#3fa";
    rhythmLight.style.boxShadow = "0 0 8px #3fa";
  } else {
    rhythmLight.style.backgroundColor = "#f44";
    rhythmLight.style.boxShadow = "0 0 10px #f44";
  }
}

function turnRhythmOff() {
  rhythmLight.style.backgroundColor = "#444";
  rhythmLight.style.boxShadow = "0 0 4px #000";
}



document.addEventListener("selectionchange", updateRhythmLight);
editor.addEventListener("input", updateRhythmLight);



</script>
</body>
</html>
